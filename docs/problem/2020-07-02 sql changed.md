### 服务查询结果与SQL执行结果不一致问题
早上8点到公司，开心吃着早饭，准备学习（白嫖公司）一波，还没吃完，群里就反馈用户无法开机。。。。 被白嫖一波。

#### 背景
部门做零售收银这块，为支持离线商户的使用，提高商户使用体验，增加了``同步下行``的机制，就是客户端分批增量拉服务端数据，客户端根据返回的数据重新组装参数，  
再次请求服务端。
```
场景示例：
服务端数据：1，2，3，4，5，6，7，8，9，10
客户端第一次请求：param = 0， 返回：1，2，3，4，5
客户端根据返回中的最大id再请求：param=5,返回：6，7，8，9，10
第三次请求：param = 10，返回[],
执行完成。
PS：param中还有``时间``参数，共同构成查询条件。
```
早上突然报的问题是，客户端开机无限执行「同步下行」拉数据，导致无法开机。

#### 排查
从日志排查，param中的参数（如：5）存在重复的情况，并且在结果中，返回了查询条件的值（5），导致相同条件（5）无限查询。

1、缓存吗？正常逻辑不应该有缓存，排查redis，无缓存；
2、客户端问题吗？所以不应该是这个问题，病急也让客户端的同学排查了。
3、通过链路排查，发现客户端收到的结果，跟日志中记录的结果的数量一致；把sql在数据平台中执行，却同前两者不一致，咨询DBA，确认平台数据源没有问题。
4、客户端的请求会经过一个服务中转，做少量逻辑处理，是不是做了缓存？沟通，没有做缓存。
5、日志问题吗，不应该，相信阿里爸爸
6、服务中的确是查询到数据，库配置不对？检查库，没配置错误
7、框架有问题，是谁改变了查询条件？
8、同事本地请求生产环境，复现问题
9、拉数据到本地，本地debug
10、mybatis参数设置没有问题，PrepareStatement设置参数没有问题
11、按理说sql执行和mybatis打印的参数肯定有差异才对，断点获取执行的sql=statement.toString()，``时间参数``与mybatis设置的参数不一致
12、一路断点发现：com.mysql.cj.ClientPreparedQueryBindings#setTimestamp()，对Timestamp做了时区处理，扣减时差之后，差了13个小时！！！

这是同事部署的新服务，昨晚上线，新服务使用了较多较新的jar，德鲁伊，mybatis，mysql-connector，这里出问题的就是mysql-connector，
通过 ``&serverTimezone=Asia/Shanghai`` 可以解决. 当然新框架，没有很多实践，风险还是很大。

### 总结
1、发版后爆问题，最快/最好的办法就是``回滚``，所以最好保持每次上线方便回滚。这次过了很久才想到回滚，在意识到是自己服务有问题就应该提回滚，  
或者知道在有上线的情况下，业务有问题，就应该马上回滚。
2、框架接入保持小步，不要跨度太大。
3、爆问题多半是自身服务的问题，要挖服务潜在问题，为了快速排查，最好能本地debug。

虽然排查耗费了不少时间，但是排查到底层的根本问题还是很开心。记录下。